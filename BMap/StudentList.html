<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <style type="text/css">
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {
            height: 90%;
            overflow: hidden;
            margin: 0;
            display: inline-block;
        }

        .myinfopic {
            width: 100%;
            height: auto;
            display: block;
        }

        .btn-startP, .btn-endP {
            margin: 10px 10px 0 0;
        }

        .top-container {
            margin-top: 15px;
        }
        table,table tr,table tr td{
            overflow: hidden;
            word-break:break-all
        }
        .list-group{
            overflow:hidden ;
            height: 90%;
        }
        .list-group:hover{
            overflow-y:auto ;
        }
        .list-group li{
            cursor: pointer;
        }
        .baidu-maps label {
            max-width: none;
        }

        .cityList{
            height: 320px;
            width:372px;
            overflow-y:auto;
        }
        .sel_container{
            z-index:9999;
            font-size:12px;
            position:absolute;
            right:0px;
            top:0px;
            width:140px;
            background:rgba(255,255,255,0.8);
            height:30px;
            line-height:30px;
            padding:5px;
        }
        .map_popup {
            position: absolute;
            z-index: 200000;
            width: 382px;
            height: 344px;
            right:0px;
            top:40px;
        }
        .map_popup .popup_main {
            background:#fff;
            border: 1px solid #8BA4D8;
            height: 100%;
            overflow: hidden;
            position: absolute;
            width: 100%;
            z-index: 2;
        }
        .map_popup .title {
            background: url("http://map.baidu.com/img/popup_title.gif") repeat scroll 0 0 transparent;
            color: #6688CC;
            font-weight: bold;
            height: 24px;
            line-height: 25px;
            padding-left: 7px;
        }
        .map_popup button {
            background: url("http://map.baidu.com/img/popup_close.gif") no-repeat scroll 0 0 transparent;
            cursor: pointer;
            height: 12px;
            position: absolute;
            right: 4px;
            top: 6px;
            width: 12px;
        }
    </style>
    <link href="http://api.map.baidu.com/library/TrafficControl/1.4/src/TrafficControl_min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.bootcss.com/jquery/2.1.3/jquery.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=3acqdMQKCRUUMQkYktd1gGUZnVjkVyVR"></script>
    <script type="text/javascript"
            src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
    <script type="text/javascript"
            src="MarkerClusterer_min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/CityList/1.2/src/CityList_min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/TrafficControl/1.4/src/TrafficControl_min.js"></script>
    <script src="studentList.js"></script>
    <script src="getRunPoints.js"></script>
    <script>

    </script>
    <title>人员定位</title>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12 top-container">
            <form class="form-inline" role="form" onsubmit="return false">
                起点：<select id="startP" class="form-control" style="margin-right: 15px">
                </select>
                终点：<select id="endP" class="form-control" style="margin-right: 15px">
                </select>
                <select id="driverType" class="form-control">
                    <option value="1">公交</option>
                    <option value="2">自驾车</option>
                    <option value="3">步行</option>
                </select>
                <button class="btn  btn-success" onclick="myCar();return false">查询路线</button>
                地址查询：<input type="text" id="address" class="form-control">
                <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;position: absolute"></div>
                <button class="btn  btn-info" id="addressBtn">查询地址</button>
                <div class="pull-right">
                    天气查询：<strong id="curCity"></strong> [<a id="curCityText" href="javascript:void(0)">更换城市</a>]
                    <div class="map_popup" id="cityList" style="display:none;">
                        <div class="popup_main">`
                            <div class="title">城市列表</div>
                            <div class="cityList" id="citylist_container"></div>
                            <button id="popup_close"></button>
                        </div>
                    </div>
                </div>
            </form>

        </div>
        <div class="col-md-2 col-xs-12">
            <div class="list-group"  id="peopleList">
                <a href="#" class="list-group-item active">
                    人员名单
                </a>
            </div>
        </div>
        <div class="col-md-7 col-xs-12 baidu-maps"  >
            <div class="col-md-12 " id="allmap"></div>
        </div>

        <div class="col-md-3 col-xs-12" id="sider"></div>
    </div>
</div>

</body>
</html>
<script type="text/javascript">
    function $$(id) {
        return document.getElementById(id)
    }
    var map = new BMap.Map('allmap');
    var point = new BMap.Point(121.622504, 38.943106);
    map.centerAndZoom(point, 14);
    map.enableDragging();
    map.enableScrollWheelZoom();

    map.addControl(new BMap.NavigationControl());
    map.addControl(new BMap.ScaleControl());
    map.addControl(new BMap.MapTypeControl({mapTypes: [BMAP_NORMAL_MAP, BMAP_HYBRID_MAP],offset: new BMap.Size(130, 10)}));

    var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
        {
            "input" : "address",
            "location" : map
        }
    );
    ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
        var str = "";
        var _value = e.fromitem.value;
        var value = "";
        if (e.fromitem.index > -1) {
            value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }
        str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

        value = "";
        if (e.toitem.index > -1) {
            _value = e.toitem.value;
            value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }
        str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
        $$("searchResultPanel").innerHTML = str;
    });
    var myValue;
    ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
        var _value = e.item.value;
        myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        $$("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

        setPlace();
    });

    function setPlace(){
        function myFun(){
            var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
            map.centerAndZoom(pp, 12);
            map.addOverlay(new BMap.Marker(pp));    //添加标注
        }
        var local = new BMap.LocalSearch(map, { //智能搜索
            onSearchComplete: myFun
        });
        local.search(myValue);
    }

    var myGeo = new BMap.Geocoder();
    $$('addressBtn').onclick=function () {
        var address=$$('address').value;
        if(address){
            myGeo.getPoint(address, function(point){
                if (point) {
                    map.centerAndZoom(point, 12);
                    map.addOverlay(new BMap.Marker(point));
                }else{
                    alert("您选择地址没有解析到结果!");
                }
            });
        }
    }

    var geoc = new BMap.Geocoder();
    map.addEventListener("click", function (e) {
        console.log(e.point.lng + "," + e.point.lat);
        var pt = e.point;
        geoc.getLocation(pt, function(rs){
            var addComp = rs.addressComponents;
            console.log(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
        });
    });
    // 路况信息
    var ctrl = new BMapLib.TrafficControl({
        showPanel: false //是否显示路况提示面板
    });
    map.addControl(ctrl);
    ctrl.setAnchor(BMAP_ANCHOR_BOTTOM_RIGHT);
    const points = [];

    function addProducts(quantity) {
        const startId = points.length;
        for (var i = 0; i < quantity; i++) {
            const id = startId + i;
            points.push({
                id:id,
                lng: 113.266604 + Math.random() * 0.2,
                lat: 23.131006 + Math.random() * -0.1,
                name: "张三" + id,
                address: '鸭子桥北里14' + id + '号楼',
                info: '查看详情',
                detail: {
                    SupplierPartNumber1: "supplier_part_number_1" + id,
                    Supplier1: "supplier_1" + id,
                    ManufacturerPartNumber: "manufacturer_part_number" + id,
                    Manufacturer: "manufacturer" + id,
                    Category: "category",
                    RoHS: "rohs",
                    Description: "description",
                    Stock1: "stock_1",
                    pricing_1: "Pricing 1",
                    packaging: "Packaging",
                    part_status: "Part Status",
                    mounting_type: "Mounting Type",
                    library_ref: "Library Ref",
                    componentLink1url: "ComponentLink1URL",
                    ComponentLink1Description: "componentLink1description"
                },
                img: 'img1.jpg'
            });
        }
    }
    //根据IP获取城市
    var cityName;
    function getCityByIP(rs) {
        cityName= rs.name;
        map.setCenter(cityName);
        $$('curCity').textContent=cityName
        console.log(cityName);
    }
    var myIcon = new BMap.Icon("car.png", new BMap.Size(20,20));
    addProducts(30);
    var pointArray = [];
    var markerArray = [];
    for (var i = 0; i < points.length; i++) {
        var name = points[i].name;
        var createLi=document.createElement('a');
        createLi.href='javascript:void(0)';
        createLi.classList='list-group-item';
        createLi.textContent=name;
        createLi.dataset.point=JSON.stringify(points[i])
        $$('peopleList').appendChild(createLi)
//        peopleListHtml+="<li class='list-group-item'>"+name+"</li>"

        var marker = new BMap.Marker(new BMap.Point(points[i].lng, points[i].lat),{icon:myIcon}); // 创建点
        var label = new BMap.Label(points[i].name, {offset: new BMap.Size(25, 15)});
        marker.setLabel(label);
        markerArray.push(marker);
        map.addOverlay(marker);    //增加点
        pointArray[i] = new BMap.Point(points[i].lng, points[i].lat);
        var point = JSON.stringify(points[i]);
        addClickHandler(point, marker);
        var lngAlat = JSON.stringify({lng: points[i].lng, lat: points[i].lat});
        var startPopt = new Option(name, lngAlat);
        var endPopt = new Option(name, lngAlat);
        $$('startP').options.add(startPopt);
        $$('endP').options.add(endPopt);
    }

//    $('peopleList').innerHTML=peopleListHtml;

    var people=document.querySelectorAll('#peopleList a');
    for(var j=0;j<people.length;j++){
        (function (j) {
            people[j].onclick=function (e) {
                var markerPeo=markerArray[j-1];
                console.log(markerPeo);

                var pointPeo=JSON.parse(e.target.getAttribute('data-point'));
                var stringfyDetail=JSON.stringify(pointPeo.detail);
                var lngAlatPeo= new BMap.Point(markerPeo.point.lng, markerPeo.point.lat);
                var contentPeo = '<div class="infowin"><p><b>' + pointPeo.name + '</b></p><p>' + pointPeo.address + '</p>' +
                        '<p><a class="btn-detail" onclick=showDetail("' + pointPeo.id + '") href="javascript:void(0);"  data-detail="' + stringfyDetail+ '">' + pointPeo.info + '</a></p>' +
                        '</div><div><img class="myinfopic" src="' + pointPeo.img + '" />' +
                        '<button onclick=setStart("' + pointPeo.name + '") data-name="' + pointPeo.name + '"  class="btn-startP btn btn-primary btn-xs">设为起点</button>' +
                        '<button onclick=setEnd("' + pointPeo.name + '")  data-name="' + pointPeo.name + '"  class="btn-endP btn btn-info btn-xs">设为终点</button></button></div>';

                var infoWindowPeo = new BMap.InfoWindow(contentPeo);  // 创建信息窗口对象
                map.panTo(lngAlatPeo)
                map.openInfoWindow(infoWindowPeo,lngAlatPeo); //开启信息窗口
                document.getElementById('allmap').onload = function (){
                    infoWindowPeo.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
                }
            }
        })(j);

    }
    function addClickHandler(point, marker) {
        console.log('handle');
        marker.addEventListener("click", function (e) {
            showInfo(e, point)
        });
    }
    function showInfo(e, point) {
        var p = e.target;
        var parsePoint = JSON.parse(point);
        var dot = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var stringfyDetail=JSON.stringify(parsePoint.detail);
        var content = '<div class="infowin"><p><b>' + parsePoint.name + '</b></p><p>' + parsePoint.address + '</p>' +
                '<p><a class="btn-detail" onclick=showDetail("' + parsePoint.id + '") href="javascript:void(0);"  data-detail="' + stringfyDetail+ '">' + parsePoint.info + '</a></p>' +
                '</div><div><img class="myinfopic" src="' + parsePoint.img + '" />' +
                '<button onclick=setStart("' + parsePoint.name + '") data-name="' + parsePoint.name + '"  class="btn-startP btn btn-primary btn-xs">设为起点</button>' +
                '<button onclick=setEnd("' + parsePoint.name + '")  data-name="' + parsePoint.name + '"  class="btn-endP btn btn-info btn-xs">设为终点</button></button></div>';
        var infoWindow = new BMap.InfoWindow(content);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow, dot); //开启信息窗口
        document.getElementById('allmap').onload = function (){
            infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
        }
    }
    //让所有点在视野范围内
//    map.setViewport(pointArray);
    var markerClusterer = new BMapLib.MarkerClusterer(map, {markers: markerArray});
    var myCity = new BMap.LocalCity();
    myCity.get(getCityByIP);


    var startPoint;
    var endPoint;
    var menu = new BMap.ContextMenu();
    var txtMenuItem = [
        {
            text: '选起点',
            callback: function (e) {
                $('startP').value = e.lng + ',' + e.lat;
                startPoint = new BMap.Point(e.lng, e.lat);
            }
        },
        {
            text: '选终点',
            callback: function (e) {
                $$('endP').value = e.lng + ',' + e.lat;
                endPoint = new BMap.Point(e.lng, e.lat);
            }
        },
        {
            text: '添加标注点',
            callback: function (p) {
                var marker = new BMap.Marker(p,{icon:myIcon}), px = map.pointToPixel(p);
                map.addOverlay(marker);
                marker.enableDragging(true);
            }
        }

    ];
    for (var i = 0; i < txtMenuItem.length; i++) {
        menu.addItem(new BMap.MenuItem(txtMenuItem[i].text, txtMenuItem[i].callback, 100));
    }
    map.addContextMenu(menu);

    //driver
    function myCar() {
        var driverType = $$('driverType').value;
        map.clearOverlays();
        startPoint = new BMap.Point(JSON.parse($$('startP').value).lng, JSON.parse($$('startP').value).lat);
        endPoint = new BMap.Point(JSON.parse($$('endP').value).lng, JSON.parse($$('endP').value).lat);
        console.log(driverType, startPoint, endPoint);
        if (driverType == 1) {
            var transit = new BMap.TransitRoute(map, {
                renderOptions: {
                    map: map,
                    panel: 'sider',
                    autoViewport: true,
                    enableDragging: true
                }
            });
            transit.search(startPoint, endPoint);
        } else if (driverType == 2) {
            var driving = new BMap.DrivingRoute(map, {
                renderOptions: {
                    map: map,
                    panel: 'sider',
                    autoViewport: true,
                    enableDragging: true
                }
            });
            driving.search(startPoint, endPoint);
        } else if (driverType == 3) {
            var walking = new BMap.WalkingRoute(map, {
                renderOptions: {
                    map: map,
                    panel: "sider",
                    autoViewport: true,
                    enableDragging: true
                }
            });
            walking.search(startPoint, endPoint);
        }

    }

    //btn-startP & btn-endP
    function setStart(name) {
        console.log(name);
        var obj = $$('startP');
        for (var i = 0; i < obj.options.length; i++) {
            var optionName = obj.options[i].text;
            if (optionName == name) {
                obj.options[i].selected = true
            }
        }
    }
    function setEnd(name) {
        console.log(name);
        var obj = $$('endP');
        for (var i = 0; i < obj.options.length; i++) {
            var optionName = obj.options[i].text;
            if (optionName == name) {
                obj.options[i].selected = true
            }
        }
    }

    var selectDetail={};
    function showDetail(id) {
        for(var k=0;k<points.length;k++){
            if (points[k].id==id){
                selectDetail=points[k].detail;
                break
            }
        }
        console.log(selectDetail);
        $$('sider').innerHTML="";
        var tableContent="<table class='table'>";
        for(var j in selectDetail){
            tableContent+="<tr><td>"+j+"</td><td>"+selectDetail[j]+"</td></tr>"
        }
        tableContent+="</table>";

        $$('sider').innerHTML=tableContent;
    }

    // 创建CityList对象，并放在citylist_container节点内
    var myCl = new BMapLib.CityList({container : "citylist_container", map : map});

    // 给城市点击时，添加相关操作
    myCl.addEventListener("cityclick", function(e) {
        // 修改当前城市显示
        document.getElementById("curCity").innerHTML = e.name;
        // 点击后隐藏城市列表
        document.getElementById("cityList").style.display = "none";
        var area=e.name;
        var weatherContent='<ul>';
        var weatherData;
        searchPointByName(area,function (data) {
            weatherData=data;
            weatherContent+='<li>'+weatherData.ganmao+'</li>';
            weatherContent+='<li>'+weatherData.wendu+'</li>';
            weatherContent+='<li>'+weatherData.city+'</li>';
            weatherContent+='</ul>';
            var lngAlatPeo= new BMap.Point(e.center.lng,e.center.lat);
            var marker = new BMap.Marker(lngAlatPeo); // 创建点
            map.addOverlay(marker);    //增加点
            var infoWindowPeo = new BMap.InfoWindow(weatherContent);  // 创建信息窗口对象
            map.openInfoWindow(infoWindowPeo,lngAlatPeo); //开启信息窗口
        });

    });
    // 给“更换城市”链接添加点击操作
    document.getElementById("curCityText").onclick = function() {
        var cl = document.getElementById("cityList");
        if (cl.style.display == "none") {
            cl.style.display = "";
        } else {
            cl.style.display = "none";
        }
    };
    // 给城市列表上的关闭按钮添加点击操作
    document.getElementById("popup_close").onclick = function() {
        var cl = document.getElementById("cityList");
        if (cl.style.display == "none") {
            cl.style.display = "";
        } else {
            cl.style.display = "none";
        }
    };


    //绘制轨迹
    getRunPoints(function (data) {
        var arrPois = [];
        for(var i=0;i<data.length;i++){
            arrPois.push(new BMap.Point(data[i].lng,data[i].lat));
        }
        /**添加终点和起点的标记**/
        addMarker(new BMap.Point(data[0].lng,data[0].lat),'终点');
        addMarker(new BMap.Point(data[data.length-1].lng,data[data.length-1].lat),'起点');
        //创建线路
        var polyline = new BMap.Polyline(
                arrPois,//所有的GPS坐标点
                {
                    strokeColor : "#009933", //线路颜色
                    strokeWeight : 4,//线路大小
                    //线路类型(虚线)
                    strokeStyle : "dashed"
                });
        //绘制线路
        map.addOverlay(polyline);
        polyline.addEventListener("click",function (e) {
            console.log(e)
        })
    });

    function addMarker(point,name){
        var marker = new BMap.Marker(point);
        var label = new BMap.Label(name, {
            offset : new BMap.Size(20, -10)
        });
        marker.setLabel(label);
        map.addOverlay(marker);
    }
</script>
